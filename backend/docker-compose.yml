services:
  waf:
    image: owasp/modsecurity-crs:nginx-alpine
    container_name: waf
    restart: unless-stopped
    ports:
      - "80:8080"     # ì™¸ë¶€ 80 â†’ ì»¨í…Œì´ë„ˆ 8080 (ë¹„ë£¨íŠ¸ ì‚¬ìš©ìž)
    environment:
      TZ: Asia/Seoul
      BACKEND: http://web:80         # ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ ëŒ€ìƒ ë°±ì—”ë“œ
      SERVER_NAME: waf.local
      ERRORLOG: /var/log/nginx/error.log
      
      # CRS Paranoia Level (1~4, ë†’ì„ìˆ˜ë¡ ì—„ê²©)
      BLOCKING_PARANOIA: 2         # ì‹¤ì œ ì°¨ë‹¨ì— ì ìš©ë˜ëŠ” ë£° ë ˆë²¨
      DETECTION_PARANOIA: 2        # íƒì§€ë§Œ í•˜ëŠ” ë£° ë ˆë²¨
      
      # Anomaly Scoring (ë‚®ì„ìˆ˜ë¡ ì—„ê²©, Default 5/4)
      ANOMALY_INBOUND: 5           # ìš”ì²­ ìŠ¤ì½”ì–´ ìž„ê³„ê°’
      ANOMALY_OUTBOUND: 4          # ì‘ë‹µ ìŠ¤ì½”ì–´ ìž„ê³„ê°’
      
      # ModSecurity ì—”ì§„ ì„¤ì •
      MODSEC_RULE_ENGINE: "On"       # On=ì°¨ë‹¨(Default), DetectionOnly=ë¡œê·¸ë§Œ
      MODSEC_AUDIT_ENGINE: "RelevantOnly"  # ì˜¤íƒ íŠœë‹ ë‹¨ê³„ìš©(Default), ì´í›„ Onìœ¼ë¡œ ë³€ê²½
      MODSEC_AUDIT_LOG_FORMAT: "Native"

      # ðŸ†• íŒŒì¼ í¬ê¸° ì œí•œ (10MB/50MB)
      MAX_FILE_SIZE: 10485760
      COMBINED_FILE_SIZES: 52428800

    volumes:
      # ë¡œê·¸ ìˆ˜ì§‘ ê²½ë¡œ
      - ../logs/nginx:/var/log/nginx
      - ../logs/modsecurity:/var/log/modsecurity

      # ì»¤ìŠ¤í…€ ë£° (CRS ì „í›„ ì‹¤í–‰)
      - ../waf/rules/REQUEST-900-EXCLUSION-RULES-BEFORE-CRS.conf:/etc/modsecurity.d/owasp-crs/rules/REQUEST-900-EXCLUSION-RULES-BEFORE-CRS.conf
      - ../waf/rules/RESPONSE-999-EXCLUSION-RULES-AFTER-CRS.conf:/etc/modsecurity.d/owasp-crs/rules/RESPONSE-999-EXCLUSION-RULES-AFTER-CRS.conf
      
    # ë©”ëª¨ë¦¬ ê¸°ë°˜ ìž„ì‹œ íŒŒì¼ ì‹œìŠ¤í…œ (ì„±ëŠ¥ ìµœì í™”)
    tmpfs:
      - /tmp:rw,mode=1777
      - /var/cache/nginx:rw,mode=1777
      
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"
        
    depends_on:
      - web
    networks:
      - shared_network

  web:
    image: nginx:alpine
    container_name: web
    command: sh -c "echo 'OK' > /usr/share/nginx/html/index.html && nginx -g 'daemon off;'"
    networks:
      - shared_network

  mysql:
    image: mysql:8.0
    container_name: waf-mysql
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD}
      MYSQL_DATABASE: waf
      MYSQL_CHARACTER_SET_SERVER: utf8mb4
      MYSQL_COLLATION_SERVER: utf8mb4_unicode_ci
    ports:
      - "3306:3306"
    volumes:
      - mysql-data:/var/lib/mysql
    command: --default-authentication-plugin=mysql_native_password
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      timeout: 5s
      retries: 10
    networks:
      - shared_network

  redis:
    image: redis:7-alpine
    container_name: waf-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      - shared_network

  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    container_name: waf-zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"
    volumes:
      - zookeeper-data:/var/lib/zookeeper/data
      - zookeeper-logs:/var/lib/zookeeper/log
    networks:
      - shared_network

  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: waf-kafka
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
      - "9093:9093"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: 'true'
      KAFKA_LOG_RETENTION_HOURS: 168
      KAFKA_LOG_SEGMENT_BYTES: 1073741824
      KAFKA_LOG_RETENTION_CHECK_INTERVAL_MS: 300000
    volumes:
      - kafka-data:/var/lib/kafka/data
    healthcheck:
      test: ["CMD", "kafka-broker-api-versions", "--bootstrap-server", "localhost:9092"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - shared_network

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.10.0
    container_name: waf-elasticsearch
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    ports:
      - "9200:9200"
      - "9300:9300"
    volumes:
      - elasticsearch-data:/usr/share/elasticsearch/data
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9200/_cluster/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
    networks:
      - shared_network

networks:
  shared_network:
    driver: bridge

volumes:
  mysql-data:
  redis-data:
  zookeeper-data:
  zookeeper-logs:
  kafka-data:
  elasticsearch-data: