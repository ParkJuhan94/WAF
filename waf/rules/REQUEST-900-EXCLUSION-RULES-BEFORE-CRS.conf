# ---------------------------------------------------------------
# CRS REQUEST-900 EXCLUSION RULES BEFORE CRS
# ---------------------------------------------------------------
# 이 파일은 CRS(Core Rule Set) 룰이 적용되기 전에 실행됩니다.
# 오탐(False Positive)을 줄이기 위한 예외 규칙을 여기에 추가하세요.

# ===============================================================
# Google OAuth 예외 규칙
# ===============================================================
# Google OAuth 콜백 경로에서 CRS 룰 완화
# OAuth2 authorization code, state, id_token은 긴 랜덤 문자열로
# SQLi, XSS 룰에서 오탐이 발생할 수 있음

# 1. Spring Security OAuth2 리디렉션 경로 예외
SecRule REQUEST_URI "@beginsWith /login/oauth2/code/google" \
    "id:900100,\
    phase:1,\
    pass,\
    nolog,\
    msg:'Google OAuth callback - disable SQLi/XSS rules',\
    ctl:ruleRemoveById=941000-942999"

# 2. 백엔드 API Google 인증 경로 예외
SecRule REQUEST_URI "@beginsWith /api/v1/auth/google" \
    "id:900101,\
    phase:1,\
    pass,\
    nolog,\
    msg:'Google OAuth API - disable rules for specific params',\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:code,\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:state,\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:id_token,\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:credential"

# 3. JWT 토큰 Authorization 헤더 예외 (Bearer 토큰)
SecRule REQUEST_HEADERS:Authorization "@rx ^Bearer " \
    "id:900102,\
    phase:1,\
    pass,\
    nolog,\
    msg:'JWT Bearer token - disable rules for Authorization header',\
    ctl:ruleRemoveTargetById=942000-942999;REQUEST_HEADERS:Authorization,\
    ctl:ruleRemoveTargetById=941000-941999;REQUEST_HEADERS:Authorization"

# ===============================================================
# 예시 규칙 (참고용)
# ===============================================================
# 예시: 특정 경로에 대해 특정 룰 비활성화
# SecRule REQUEST_URI "@beginsWith /api/upload" \
#     "id:900001,phase:1,pass,nolog,ctl:ruleRemoveById=920420"

# 예시: 특정 파라미터에 대해 SQL Injection 검사 비활성화
# SecRule REQUEST_URI "@beginsWith /api/search" \
#     "id:900002,phase:2,pass,nolog,ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:query"
