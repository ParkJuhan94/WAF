# CRS가 전부 로딩된 "이후"에 실행될 커스텀 룰(탐지/차단/체인 등)

# === 기본 Path Traversal 탐지 ===
SecRule REQUEST_URI|ARGS "(?:\.\./|%2e%2e/)" \
  "id:1000050,phase:2,log,pass,t:urlDecodeUni,msg:'Path traversal seen',tag:'custom'"

# === 강화된 보안 룰 ===

# 1. 악성 파일 업로드 차단 강화 (점수 + 즉시 차단)
SecRule ARGS "@rx \.(?i:php|phtml|php3|php4|php5|phps|asp|aspx|jsp|jspx|cgi|pl|py|rb|sh|exe|bat|cmd)$" \
    "id:9001,\
    phase:2,\
    deny,\
    status:403,\
    msg:'악성 파일 확장자 업로드 차단: %{MATCHED_VAR}',\
    logdata:'파일: %{MATCHED_VAR_NAME}=%{MATCHED_VAR}',\
    tag:'file-upload-block',\
    tag:'custom-rule',\
    severity:'CRITICAL',\
    setvar:'tx.anomaly_score_pl1=+%{tx.critical_anomaly_score}'"

# 2. 웹쉘 관련 파일명 패턴 차단
SecRule ARGS "@rx (?i:shell|webshell|backdoor|bypass|exploit|hack)" \
    "id:9002,\
    phase:2,\
    block,\
    msg:'웹쉘 관련 파일명 차단',\
    tag:'webshell-filename'"

# 3. 시스템 파일 접근 강화 (절대 경로)
SecRule ARGS "@rx ^/(?:etc|var|usr|bin|boot|dev|lib|opt|proc|root|sbin|sys|tmp)/" \
    "id:9003,\
    phase:2,\
    block,\
    msg:'시스템 디렉터리 절대 경로 접근 차단: %{MATCHED_VAR}',\
    tag:'system-file-access'"

# 4. RFI 프로토콜 차단 강화
SecRule ARGS "@rx (?i:https?|ftp|ftps|file|gopher|dict|ldap|sftp)://" \
    "id:9004,\
    phase:2,\
    block,\
    msg:'Remote File Inclusion 프로토콜 차단',\
    tag:'rfi-protocol'"

# 5. 특정 확장자와 프로토콜 조합 차단
SecRule ARGS "@rx (?i:https?://.+\.(?:php|asp|jsp|txt|dat))" \
    "id:9005,\
    phase:2,\
    block,\
    msg:'원격 스크립트 파일 포함 차단',\
    tag:'remote-script'"

# 6. UTF-8 인코딩 우회 차단
SecRule ARGS "@rx %c0%ae" \
    "id:9006,\
    phase:2,\
    block,\
    msg:'UTF-8 인코딩 경로 조작 차단',\
    tag:'utf8-bypass'"

# 7. Apache/Nginx 로그 파일 접근 차단
SecRule ARGS "@rx (?i:/var/log/(?:apache2?|nginx|httpd)/)" \
    "id:9007,\
    phase:2,\
    block,\
    msg:'웹서버 로그 파일 접근 차단',\
    tag:'log-file-access'"

# 8. /proc, /sys 시스템 정보 접근 차단
SecRule ARGS "@rx (?i:/(?:proc|sys)/)" \
    "id:9008,\
    phase:2,\
    block,\
    msg:'시스템 정보 파일 접근 차단',\
    tag:'system-info-access'"